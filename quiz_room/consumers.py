# quiz_room.consumers.py 

# ì›¹ì†Œì¼“ í´ë¼ì´ì–¸íŠ¸ì™€ í…ìŠ¤íŠ¸ ë°ì´í„° ì†¡ìˆ˜ì‹  ì‹œì— Json ì§ë ¬í™”&ì—­ì§ë ¬í™”ê¹Œì§€ ëª¨ë‘ ì²˜ë¦¬ 
from channels.generic.websocket import JsonWebsocketConsumer
# import openai
from django.contrib.auth.models import User
from quiz_room.models import Quizroom

'''
# 1. í† í° ë°›ì•„ì˜¤ê¸° 
# 2. í† í°ê³¼ ì—°ê²°ëœ ì‚¬ìš©ì ë°˜í™˜ 
# 3. í•´ë‹¹ ì‚¬ìš©ìì—ê²Œ í•´ë‹¹ idì˜ ë°© ì¡´ì¬ ì—¬ë¶€ íŒŒì•… 
# 4. ë°© ë°˜í™˜
'''

# ì„œë²„ì¸¡ ì›¹ì†Œì¼“ ì—°ê²° ì²˜ë¦¬ 
class QuizroomConsumer(JsonWebsocketConsumer):
    # ìƒì„±ì
    def __init__(self, *args, **kargs): 
        # ë¶€ëª¨ í´ë˜ìŠ¤ ì´ˆê¸°í™”
        super().__init__(*args, **kargs) 


    # ì›¹ì†Œì¼“ ì—°ê²° ìš”ì²­ì„ ë°›ìœ¼ë©´ í˜¸ì¶œ
    def connect(self): 
    #     room = self.get_room() # ì±„íŒ…ë°© ì¡°íšŒ 
    #     if room is None: 
    #         print("ì—°ê²° ê±°ë¶€")
    #         self.close() # ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì´ë©´ ì—°ê²° ê±°ë¶€
    #     else: 
    #         print("ì—°ê²°ë¨")
    #         self.accept() # ë°©ì´ ì¡´ì¬í•˜ë©´ ì—°ê²° ìˆ˜ë½
        print("ì—°ê²°ë¨")
        self.accept() # ë°©ì´ ì¡´ì¬í•˜ë©´ ì—°ê²° ìˆ˜ë½


    # ì›¹ì†Œì¼“ì— ì—°ê²°ëœ í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ë°ì´í„°ë¥¼ ìˆ˜ì‹ í•  ë•Œë§ˆë‹¤ í˜¸ì¶œë¨
    def receive_json(self, content_dict, **kargs):
        #  receive_jsoní˜¸ì¶œ ì „ì—, json.loadsë¡œ ì—­ì§ˆë ¬í™” ì²˜ë¦¬ë¥¼ ê±°ì³ íŒŒì´ì¬ ê°ì²´(content)ë¥¼ ì¸ìë¡œ ë„˜ê²¨ì¤Œ # content ì¸ìëŠ” íŒŒì´ì¬ ê°ì²´ì´ë©°, ë³´í†µ ë”•ì…”ë„ˆë¦¬ íƒ€ì…ì„ 
        print(f"ğŸ“© received: {content_dict}")  # ë””ë²„ê¹…ìš© ì¶œë ¥
        
        # Echo ì‘ë‹µ (ìˆ˜ì‹ í•œ ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ í´ë¼ì´ì–¸íŠ¸ì— ì „ì†¡)
        self.send_json(content_dict)




    # # ì±„íŒ…ë°© ì¡°íšŒ
    # def get_room(self) -> Quizroom | None: # ì±„íŒ…ë°© ì¡´ì¬í•˜ë©´ ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜, ì—†ìœ¼ë©´ None ë°˜í™˜ 
    #     room: Quizroom = None # ì´ˆê¸°ê°’ì„ Noneìœ¼ë¡œ ì„¤ì •í•˜ì—¬, ë°© ëª»ì°¾ìœ¼ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜ 

    #     # í˜„ì¬ ìš”ì²­ User ì¸ìŠ¤í„´ìŠ¤
    #         #  self.scope["user"]ë¥¼ í†µí•´ ì‚¬ìš©(ë·°ì—ì„œ request.uesrì™€ ê°™ì€ ì˜ë¯¸)
    #     user: User = self.scope["user"]
        
    #     # í€´ì¦ˆë£¸ pk 
    #         # routing.pyì—ì„œ url captured valueë¡œì„œ quizroom_idë¥¼ ì§€ì •í–ˆì—ˆìŒ
    #     quizroom_id = self.scope["url_route"]["kwargs"]["quizroom_id"]   

    #     # í˜„ì¬ ìœ ì €ê°€ ë¡œê·¸ì¸ ìƒíƒœë¼ë©´(ì‚¬ìš©ì ì¸ì¦ í™•ì¸)
    #     if user.is_authenticated:
    #         print(f"ì‚¬ìš©ì {user}ì˜ {quizroom_id}ë²ˆ ë°© ì¡°íšŒ... ")    
    #         try:
    #             room = Quizroom.objects.get(pk=quizroom_id, user=user)
    #         except Quizroom.DoesNotExist: # ë¡œê·¸ì¸ ìœ ì €ì— ëŒ€í•´ ì±„íŒ…ë°©ì„ ëª»ì°¾ì€ ê²½ìš° 
    #             pass
    #     else:
    #         print("ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    #     # ì¡°íšŒí•œ ì±„íŒ…ë°© ê°ì²´ ë°˜í™˜
    #     return room 
   